<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="https://www.w3.org/1999/xhtml">
<head>
  <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600" rel="stylesheet" type="text/css">
  <link href="https://fonts.googleapis.com/css?family=Cousine&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <link rel="icon" type="image/ico" href="/images/favicon.ico" />
  <link rel="shortcut icon" type="image/png" href="/images/favicon.png" />
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Style-Type" content="text/css" />
  <meta name="generator" content="pandoc" />
  <title>Solar2D Documentation — Developer Guides | HTML5</title>
  <meta name="description" content="Solar2D lets you build games/apps for all major platforms including iOS, Android, Kindle, Apple TV, Android TV, macOS, and Windows. Get the free toolset!" />
  <link rel="stylesheet" href="../../../css/style.css" />
  <link rel="stylesheet" href="../../../css/shCoreDefault.css" />
<script src="https://corona-cdn.coronalabs.com/js/docs.js"></script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-9574984-14', 'auto');
  ga('send', 'pageview');
</script>
</head>
<body>
<div class="header"></div>
<div class="title">
	<span class="titleimg" onclick="window.location='https://docs.coronalabs.com/'"></span>
	<div id="nav">
		<ul>
<li><a href="../../../guide/programming/index.html">Getting Started</a></li>
<li><a href="../../../guide/index.html">Guides</a></li>
<li><a href="../../../api/index.html">API Reference</a></li>
<li><a href="../../../tutorial/index.html">Tutorials</a></li>
<li><a href="../../../plugin/index.html">Plugins</a></li>
<li><a href="../../../native/index.html">Solar2D Native</a></li>
<li><a href="../../../coronacards/index.html">CoronaCards</a></li>
</ul>

		<!--
		<div id="resources-link"><a href="https://coronalabs.com/resources/">Corona Resources</a></div>
		-->
	</div>
</div>

<div class="SearchBar">
  <form action="https://www.google.com/cse" id="cse-search-box">
  <input type="hidden" name="cx" value="009283852522218786394:g40gqt2m6rq" />
  <input type="hidden" name="ie" value="UTF-8" />
  <input type="text" placeholder="Search" name="q" id="q" autocomplete="off" size="40" />
  <input type="submit" name="sa" value="Search" />
  </form>
</div>
<div id="TOC">
<ul>
<li><a href="#using-javascript-in-html5-builds">Using JavaScript in HTML5 Builds</a><ul>
<li><a href="#javascript-module-loader">JavaScript Module Loader</a><ul>
<li><a href="#making-a-dummy-wrapper-for-simulator">Making a dummy wrapper for Simulator</a></li>
</ul></li>
<li><a href="#bridging-between-lua-and-javascript">Bridging between Lua and JavaScript</a><ul>
<li><a href="#passing-functions-to-javascript">Passing functions to JavaScript</a><ul>
<li><a href="#assigning-lua-function-to-a-property">1. Assigning Lua function to a property</a></li>
<li><a href="#passing-lua-functions-as-parameters">2. Passing Lua functions as parameters</a></li>
</ul></li>
</ul></li>
<li><a href="#plugin-example">Plugin example</a><ul>
<li><a href="#init"><code>init()</code></a></li>
<li><a href="#init_internal"><code>init_internal()</code></a></li>
</ul></li>
<li><a href="#packaging-html5-plugins">Packaging HTML5 plugins</a></li>
<li><a href="#support">Support</a></li>
</ul></li>
</ul>
</div>
<div id="breadcrumb">
<a href="https://docs.coronalabs.com">Documentation</a>  ▸  <a href="../../../guide/index.html">Developer Guides</a>  ▸  [HTML5][guide.html5]
</div>
<section id="using-javascript-in-html5-builds" class="level1">
<h1>Using JavaScript in HTML5 Builds</h1>
<p>This guide explains how to interact between JavaScript and Lua code when running HTML5 build.</p>
<div class="guide-notebox">
<div class="notebox-title">
Note
</div>
<p>HTML5 builds are still in beta. Things in this guide may be subject for changes.</p>
</div>
<div class="guides-toc">
<ul>
<li><a href="#loader">JavaScript Module Loader</a></li>
<li><a href="#wrapper">Making a dummy wrapper for Simulator</a></li>
<li><a href="#luaJs">Bridging between Lua and JavaScript</a></li>
<li><a href="#funcToJs">Passing functions to JavaScript</a>
<ul>
<li><a href="#funcToJsProp">Assigning Lua function to a property</a></li>
<li><a href="#funcToJsParam">Passing Lua functions as parameters</a></li>
</ul></li>
<li><a href="#example">Plugin example</a></li>
<li><a href="#packaging">Packaging HTML5 plugins</a></li>
<li><a href="#support">Support</a></li>
</ul>
</div>
<p>HTML5 provides extremely rich access to a variety of APIs, both built-in and third party integrations. It would be impossible to create bindings for all of them in Lua. This is why Solar2D provides an extremely easy way to bridge between Lua and JavaScript code.</p>
<p><a id="plugin"></a></p>
<section id="javascript-module-loader" class="level2">
<h2>JavaScript Module Loader</h2>
<p>When trying to <code>require</code> a module from Lua, one can make use of the JavaScript Module Loader included into HTML5 builds. It looks for file in root of the project with <code>.js</code> extension.</p>
<p>For example:</p>
<pre class="brush: lua;">local demo_plugin = require "demo_plugin"</pre>
<p>would also look for <code>demo_plugin.js</code> to load as a module when running in a web browser. Note that Simulator can not execute JavaScript plugins.</p>
<p>In order for the module to get loaded, the file must define a global object with same name as the module name, <code>demo_plugin</code> in this case. Here’s sample contents of <code>demo_plugin.js</code>:</p>
<pre class="brush: js;">demo_plugin = {
    init: function() { 
        console.log( "Init was called" );
    }
}</pre>
<p>You can execute additional JS code in body of the file, but it is recommended to move all initialization into functions, like <code>init</code>.</p>
<p>Note, that if file contains syntactical errors it would produce runtime errors during runtime in the HTML5 build. If you see <code>ERROR: module "demo_plugin" not found</code> error popup, check the JavaScript Console from browser’s developer tools. If it has warning like <code>Module file is loaded, but object 'demo_plugin' is not found!</code> it means that module contained syntax errors, so it failed to create global module object.</p>
<p><a id="wrapper"></a></p>
<section id="making-a-dummy-wrapper-for-simulator" class="level3">
<h3>Making a dummy wrapper for Simulator</h3>
<p>It can be bothersome to develop plugins that are getting errors all the time since JS code doesn’t work in simulator. For that purpose we recommend making a Lua wrapper. It should check if JavaScript can be executed, and do so if possible.</p>
<p>For that you would create two files: <code>demo_plugin.lua</code>:</p>
<pre class="brush: lua;">if system.getInfo("platform") == 'html5' then
    return require "demo_plugin_js"
else
    local lib = {}
    setmetatable( lib, {__index = function( t, k )
        return function() 
            print( "WARNING: Placeholder is called for " .. k )
        end
    end} )
    return lib
end</pre>
<p>This simple Lua wrapper would return a dummy function for all requests, unless it is running on <code>html5</code> platform. In that case, it would return real plugin contained in <code>demo_plugin_js.js</code> file:</p>
<pre class="brush: js;">demo_plugin_js = {
    init: function() { 
        console.log( "Init was called" );
    }
}</pre>
<p>Note that module’s object has to be renamed to <code>demo_plugin_js</code> as well.</p>
<p><a id="luaJs"></a></p>
</section>
</section>
<section id="bridging-between-lua-and-javascript" class="level2">
<h2>Bridging between Lua and JavaScript</h2>
<p>We tried to make bridging between Lua and JavaScript as seamless as possible. Our bridge works only in one direction: you can call methods or access properties of you JS module object from Lua.</p>
<p>To demonstrate that, lets add some properties to our <code>demo_plugin_js.js</code>:</p>
<pre class="brush: js;">demo_plugin_js = {
    init: function() { 
        console.log( "Init was called" );
    },
    someInt: 42,
    someString: "Hello World!",
    log: function( p ) {
        console.log( "Log called", p, this.someInt, this.someString );
    }
}</pre>
<p>And here how we can access them from <code>main.lua</code>:</p>
<pre class="brush: lua;">local demo = require "demo_plugin"
demo.init()
print( "Values:", demo.someInt, demo.someString )
demo.someInt = -1
demo.someString = "Hi!"
demo.log( 42 )</pre>
<p>Now build this for HTML5. Make sure to open <a href="http://127.0.0.1:20605/index-debug.html">/index-debug.html</a> to see output from Lua’s <code>print</code> instructions. It is hidden in default index file. You should see that everything works as expected. Methods are getting called, printed values are displayed and assigned properties work as well. Values passed as parameters, assigned to properties or returned by methods are copied and go through simple type transformation to be passed between JS &amp; Lua environments. If types cannot be copied or transparently converted, they are omitted.</p>
<p><a id="funcToJs"></a></p>
<section id="passing-functions-to-javascript" class="level3">
<h3>Passing functions to JavaScript</h3>
<p>We have already seen that it is very straightforward to call JavaScript functions from Lua. But it is often required to do the reverse - invoke a callback to Lua when some JavaScript async operations is finished. This is tricky, since JavaScript doesn’t provide any mechanisms to interact with its garbage collector. Simpler, value types like strings, numbers or event tables can be copied between Lua and JavaScript, so memory leaks are not a problem because copies are handled separately on each side. Functions on other hand, must maintain connection to their environment in order to perform expected tasks. Nevertheless, Solar2D provides two ways that allow Lua functions can be passed to Javascript:</p>
<p><a id="funcToJsProp"></a></p>
<section id="assigning-lua-function-to-a-property" class="level4">
<h4>1. Assigning Lua function to a property</h4>
<p>in <code>main.lua</code>:</p>
<pre class="brush: lua;">local function callbackFunction( message )
    print( message )
end
local demo = require "demo_plugin"
demo.callback = callbackFunction
demo.execute()</pre>
<p>In <code>demo_plugin_js.js</code>:</p>
<pre class="brush: js;">demo_plugin_js = {
    execute: function() { 
        this.callback( "Hello World" );
    }
}</pre>
<p>This works as expected and prints “Hello World” to the <a href="http://127.0.0.1:20605/index-debug.html">index-debug.html</a> console. If <code>demo.callback</code> is assigned from Lua, the JS Module Loader would take care of memory management. If you want to assign something to <code>this.callback</code> from JavaScript, make sure to <em>release</em> it before hence. More on this in next section.</p>
<p><a id="funcToJsParam"></a></p>
</section>
<section id="passing-lua-functions-as-parameters" class="level4">
<h4>2. Passing Lua functions as parameters</h4>
<p>The previous method, while simple, is not very elegant or idiomatic from Lua point of view. In Lua we usually pass functions around as parameters. This causes problems in interface bridges to other languages, since we have to “hold on” to passed functions. When the Lua C API is used, we manually have to tell the garbage collector that particular function is being used and shouldn’t be collected as garbage.</p>
<p>A similar approach is implemented in JS Module Loader. When functions are passed from Lua to JavaScript it is transformed to a <em>reference</em> and you have a choice to “hold on” to it and create a callable JavaScript function. When it is not needed anymore, you should release it to prevent memory leaks.</p>
<p>Here is all APIs to work with functions passed to JavaScript:</p>
<ul>
<li><code>LuaIsFunction</code> returns <code>boolean</code>. <code>true</code> if the passed value represents a valid Lua function <em>reference</em>.</li>
<li><code>LuaCreateFunction</code> transforms a Lua function <em>reference</em> to a callable JavaScript function and returns it.</li>
<li><code>LuaReleaseFunction</code> releases a <em>reference</em> to an underlying Lua function. Calling released functions would result in a no-op (do nothing).</li>
</ul>
<p>Modus operandi is supposed to be as follows: receive a Lua function <em>reference</em> as a parameter. Create a JavaScript function wrapper from this <em>reference</em>. Call the wrapper function, and release when it is no longer needed.</p>
<p>Let’s demonstrate how it works with an example: <code>main.lua</code>:</p>
<pre class="brush: lua;">local function callbackFunction( message )
    print( message )
end
local demo = require "demo_plugin"
demo.execute( callbackFunction )</pre>
<p><code>demo_plugin_js.js</code>:</p>
<pre class="brush: js;">demo_plugin_js = {
    execute: function( callbackReference ) {
        if( LuaIsFunction( callbackReference ) ) {
            var f = LuaCreateFunction( callbackReference );
            f( "Hello World" );
            LuaReleaseFunction( f );
        }
    }
}</pre>
<p>This approach can be used with async calls as well. In this case make sure to use <code>LuaCreateFunction</code> right after receiving parameters. All function references are released right after exiting method they was passed to:</p>
<p><code>demo_plugin_js.js</code>:</p>
<pre class="brush: js;">demo_plugin_js = {
    execute: function( callbackReference ) {
        if( LuaIsFunction( callbackReference ) ) {
            var f = LuaCreateFunction( callbackReference );
            setTimeout( function() {
                f( "Hello World" );
                LuaReleaseFunction( f );
            }, 1000 )
        }
    }
}</pre>
<p><a id="example"></a></p>
</section>
</section>
</section>
<section id="plugin-example" class="level2">
<h2>Plugin example</h2>
<p>To see example of real-world plugin check out our VK Direct Games plugin available on <a href="https://github.com/coronalabs/com.coronalabs-plugin.vk.direct/blob/master/plugins/2018.3275/web/plugin_vk_direct_js.js">GitHub</a>. Lets review some notable parts.</p>
<section id="init" class="level4">
<h4><code>init()</code></h4>
<p>Function <code>init()</code> is most interesting. It has 2 parts. First - it remembers callback to dispatch events to:</p>
<pre class="brush: js;">        LuaReleaseFunction( this.callback );
        if ( LuaIsFunction( callback ) ) {
            this.callback = LuaCreateFunction( callback );
        } else {
            this.callback = function(){};
        }</pre>
<p>The first line releases an existing callback if there is one. Then it creates new callback from reference and assigns it to a <code>callback</code> property. If the new callback is not set, we just use empty function as a callback to prevent runtime errors and excessive checks.</p>
<p>Second part:</p>
<pre class="brush: js;">        if ( this.init_internal ) {
            this.init_internal();
            this.init_internal = null;
        }</pre>
<p>It calls the method <code>init_internal</code> then sets it to <code>null</code> so it won’t be called again. This is simple way to make sure <code>init_internal</code> is called only once.</p>
</section>
<section id="init_internal" class="level4">
<h4><code>init_internal()</code></h4>
<p>VK Direct Games is a third party integration. We have to use an external JavaScript library to use it. The library loaded and initialized in <code>init_internal()</code> method. Lets take a look:</p>
<pre class="brush: js;">    init_internal: function()
    {
        var script = document.createElement('script');
        script.setAttribute('src', 'https://vk.com/js/api/mobile_sdk.js');
        script.setAttribute('type', 'text/javascript');
        script.setAttribute('charset', 'utf-8');

        script.onerror = function()
        {
            // ...
        };

        script.onload = function()
        {
            // ... initOK = ... initFail = ...
            VK.init(initOK, initFail, '5.60');
        };
        document.head.appendChild(script);
    }</pre>
<p>In this code, we programmatically create a <code>&lt;script/&gt;</code> element and attach it to our HTML page. We also set <code>onerror</code> and <code>onload</code> handlers where we dispatch messages. Also, we call <code>VK.init</code> when the script is loaded to initialize VK APIs. Check out original code for more details.</p>
<p><a id="packaging"></a></p>
</section>
</section>
<section id="packaging-html5-plugins" class="level2">
<h2>Packaging HTML5 plugins</h2>
<p>Follow the existing <a href="https://docs.coronalabs.com/native/plugin/submission.html">plugin submission guide</a>. To add HTML5 JS plugins, put your JS &amp; Lua files alongside with the <code>metadata.lua</code> to <code>web</code> folder next to other platforms plugins.</p>
<p>Sample <code>metadata.lua</code>:</p>
<pre class="brush: lua;">local metadata = {
    plugin =
    {
        format = 'js',
    },
}
return metadata</pre>
<p>Use <a href="https://github.com/coronalabs/com.coronalabs-plugin.vk.direct/blob/master/plugins/2018.3275/web/plugin_vk_direct_js.js">VK Direct Games plugin</a> as an example.</p>
<p><a id="support"></a></p>
</section>
<section id="support" class="level2">
<h2>Support</h2>
<p>If you have any questions or ideas, feel free to join community discussions on the <a href="https://forums.solar2d.com/c/beta-testing/html5/96">forums</a> or <a href="https://discord.gg/Abf5V9G">Discord</a>.</p>
<hr>
<div id="footer">
<p class="copyright">
© 2020-2024 Solar2D All Rights Reserved.
</p>
<p class="feedback">
Help us help you! If you notice a problem with this page, please report it.
</p>
<p><a class="feedback-button" href="https://github.com/coronalabs/corona-docs/issues" target="_blank">Report an Issue</a></p>
</div>
</section>
</section>
<script src="https://corona-cdn.coronalabs.com/js/SyntaxHighlighter/shCore.js" type="text/javascript"></script>
<script src="https://corona-cdn.coronalabs.com/js/SyntaxHighlighter/shAutoloader.js" type="text/javascript"></script>
<script type="text/javascript">
    // Define syntax highlighting scripts.
    // N.B.: As a safeguard, you will need to whitelist the brush in filter-SyntaxHighlighter.py

    SyntaxHighlighter.autoloader(
      ['c#','https://corona-cdn.coronalabs.com/js/SyntaxHighlighter/shBrushCSharp.js'],
      ['java','https://corona-cdn.coronalabs.com/js/SyntaxHighlighter/shBrushJava.js'],
      ['js','https://corona-cdn.coronalabs.com/js/SyntaxHighlighter/shBrushJScript.js'],
      ['lua','https://corona-cdn.coronalabs.com/js/SyntaxHighlighter/shBrushLua.js'],
      ['php','https://corona-cdn.coronalabs.com/js/SyntaxHighlighter/shBrushPhp.js'],
      ['sql','https://corona-cdn.coronalabs.com/js/SyntaxHighlighter/shBrushSql.js'],
      ['xml','https://corona-cdn.coronalabs.com/js/SyntaxHighlighter/shBrushXml.js']
    );

    // Set default configurations.
    SyntaxHighlighter.defaults['gutter'] = false; // Disable line numbers.
    SyntaxHighlighter.defaults['toolbar'] = false; // Disable link back to author's site. :(
	SyntaxHighlighter.defaults['quick-code'] = false; // Disable double click feature

    // Perform the highlighting.
    SyntaxHighlighter.all();
</script>
</body>
</html>
